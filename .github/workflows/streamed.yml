name: ğŸ”„ Generate StreamedSU Playlist âš¡

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Python dependencies & Playwright (Chrome Beta)
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests
          python -m playwright install chromium
          python -m playwright install-deps
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-signing-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux-signing-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-beta

      - name: ğŸ¯ Run scraping script
        env:
          PYTHONUNBUFFERED: 1
        run: |
          echo "â–¶ï¸ Starting StreamedSU Scraper..."
          xvfb-run -a python streamed.py
          echo "âœ… Finished generating playlists."

      - name: ğŸ’¾ Commit & Safely Push if Playlist Changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only add files if they exist
          if [ -f "StreamedSU_VLC.m3u8" ]; then git add StreamedSU_VLC.m3u8; fi
          if [ -f "StreamedSU_TiviMate.m3u8" ]; then git add StreamedSU_TiviMate.m3u8; fi

          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi

          git commit -m "ğŸ§© Update StreamedSU Playlist âš¡ $(date -u +'%a %b %d %T UTC %Y')"

          # Random small delay to reduce push collisions
          sleep $((RANDOM % 10 + 5))

          if ! git push origin main; then
            echo "âš ï¸ Push rejected. Trying safe fetch + rebase..."
            git pull origin main --rebase || {
              echo "âŒ Rebase failed. Exiting safely."
              exit 1
            }
            git push origin main || {
              echo "âŒ Second push failed. Remote changed again."
              exit 1
            }
          fi

      - name: ğŸ’¾ Commit & Push Generated Playlists
        run: |
          echo "ğŸ“ Checking for generated playlists..."
          ls -l *.m3u8 || echo "âš ï¸ No playlists found!"
          
          if ls *.m3u8 1> /dev/null 2>&1; then
            echo "âœ… Playlists found, committing..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add *.m3u8
            git commit -m "ğŸ¶ Auto-update playlists ($(date +'%Y-%m-%d %H:%M:%S'))" || echo "âš ï¸ Nothing new to commit"
            git push
          else
            echo "âš ï¸ No playlist files to commit."
          fi

      - name: ğŸ“¤ Upload Playlist Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StreamedSU_Playlists
          path: |
            ./StreamedSU_VLC.m3u8
            ./StreamedSU_TiviMate.m3u8
          if-no-files-found: warn
