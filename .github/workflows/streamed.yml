name: ğŸ”„ Generate StreamedSU Playlist âš¡

on:
  schedule:
    - cron: '0 * * * *' # runs every hour
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Python dependencies & Playwright (Chrome Beta)
        run: |
          python -m pip install --upgrade pip
          pip install playwright requests
          python -m playwright install chromium
          python -m playwright install-deps
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-signing-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux-signing-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-beta

      - name: ğŸ¯ Run scraping script
        env:
          PYTHONUNBUFFERED: 1
        run: |
          echo "â–¶ï¸ Starting StreamedSU Scraper..."
          xvfb-run -a python streamed.py
          echo "âœ… Finished generating playlists."

      - name: ğŸ’¾ Commit & Safely Push if Playlist Changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add StreamedSU_VLC.m3u8 StreamedSU_TiviMate.m3u8

          if git diff --cached --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi

          git commit -m "âœ… Update StreamedSU Playlists âš¡ $(date -u +'%a %b %d %T UTC %Y')"

          sleep $((RANDOM % 10 + 5))

          if ! git push origin main; then
            echo "âš ï¸ Push rejected. Trying safe fetch + rebase..."
            git pull origin main --rebase || {
              echo "âŒ Rebase failed. Exiting safely."
              exit 1
            }
            git push origin main || {
              echo "âŒ Second push failed. Remote changed again."
              exit 1
            }
          fi

      - name: ğŸ“¤ Upload Playlist Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: StreamedSU_Playlists
          path: |
            StreamedSU_VLC.m3u8
            StreamedSU_TiviMate.m3u8
