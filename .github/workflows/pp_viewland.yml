name: PPV Stream Fetcher

on:
  schedule:
    # Run every 2 hours
    - cron: "0 */2 * * *"
  workflow_dispatch:
    # Allow manual run from GitHub UI

jobs:
  fetch-streams:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp playwright
        playwright install
        playwright install-deps
        
    - name: Run PPV script
      run: |
        python pp_viewland.py        
        
    - name: üíæ Commit & Safely Push if Playlist Changed
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ‚¨á‚¨á‚¨á UPDATED ‚Äî Now commits TWO PLAYLIST FILES ‚¨á‚¨á‚¨á
          git add pp_viewland.m3u8 pp_viewland_tivimate.m3u8

          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi

          git commit -m "üîÅ Update PP Viewland playlist $(date -u +'%a %b %d %T UTC %Y')"
          sleep $((RANDOM % 10 + 5))

          if ! git push origin main; then
            echo "‚ö†Ô∏è Push rejected. Trying safe fetch + merge..."
            git pull origin main --rebase || {
              echo "‚ùå Rebase failed. Exiting."
              exit 1
            }
            git push origin main || {
              echo "‚ùå Second push failed."
              exit 1
            }
          fi
