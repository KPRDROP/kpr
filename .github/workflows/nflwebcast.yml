name: NFLWebcast Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install System Dependencies (Xvfb, fonts, browser deps)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb xauth x11-apps \
          libnss3 libnspr4 libgbm1 libatk1.0-0 libcups2 \
          libxcomposite1 libxrandr2 libdbus-1-3 libxdamage1 \
          libxkbcommon0 libpango-1.0-0 libcairo2 libasound2 \
          fonts-liberation libxshmfence1

        # Shared memory fix for Chromium crashes
        sudo mount -o remount,size=1G /dev/shm || true
        df -h /dev/shm

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install playwright aiohttp aiodns bs4 lxml
        playwright install chromium

    - name: Start Xvfb (DISPLAY=:99)
      run: |
        echo "Starting Xvfb on :99 ..."
        Xvfb :99 -screen 0 1920x1080x24 -nolisten tcp &
        sleep 2
      env:
        DISPLAY: ":99"

    - name: Run scraper
      env:
        DISPLAY: ":99"
        PLAYWRIGHT_BROWSERS_PATH: "0"
        PYTHONUNBUFFERED: "1"
      run: |
        echo "ðŸš€ Running nflwebcast.py ..."
        python3 nflwebcast.py

    - name: Upload playlist
      uses: actions/upload-artifact@v4
      with:
        name: nflwebcast-playlist
        path: NFLWebcast.m3u8
