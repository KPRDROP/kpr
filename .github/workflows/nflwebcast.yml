name: NFLWebcast Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Install Ubuntu dependencies (24.04 compatible)
    # ------------------------------------------------------------
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb xauth x11-apps \
          libnss3 libnspr4 libgbm1 libatk1.0-0 libcups2 \
          libxcomposite1 libxrandr2 libdbus-1-3 libxdamage1 \
          libxkbcommon0 libpango-1.0-0 libcairo2 libasound2t64 \
          fonts-liberation libxshmfence1 curl wget gnupg

        # Improve Chrome shared memory stability
        sudo mount -o remount,size=1G /dev/shm || true

    # ------------------------------------------------------------
    # Install Google Chrome Stable
    # ------------------------------------------------------------
    - name: Install Google Chrome
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub \
          | gpg --dearmor \
          | sudo tee /usr/share/keyrings/googlechrome.gpg >/dev/null

        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/googlechrome.gpg] \
          https://dl.google.com/linux/chrome/deb/ stable main" \
          | sudo tee /etc/apt/sources.list.d/google-chrome.list

        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    # ------------------------------------------------------------
    # Install Python + Playwright (Chrome mode)
    # ------------------------------------------------------------
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install playwright aiohttp
        playwright install chrome

    # ------------------------------------------------------------
    # Start headful virtual display (Xvfb)
    # ------------------------------------------------------------
    - name: Start Xvfb
      run: |
        Xvfb :99 -screen 0 1920x1080x24 &
        echo "DISPLAY=:99" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Run the scraper
    # ------------------------------------------------------------
    - name: Run nflwebcast.py
      run: |
        echo "ðŸš€ Running nflwebcast.py ..."
        DISPLAY=:99 python3 nflwebcast.py

    # ------------------------------------------------------------
    # Upload output
    # ------------------------------------------------------------
    - name: Upload playlist
      uses: actions/upload-artifact@v4
      with:
        name: NFLWebcast.m3u8
        path: NFLWebcast.m3u8
